# Guide de mise en place de l'internationalisation (i18n) dans une application Next.js

> Ce guide technique d√©taille pas √† pas le processus de mise en place de l'internationalisation (i18n) dans une application Next.js. √Ä travers des explications claires et des exemples pratiques, vous apprendrez comment configurer votre projet Next.js pour prendre en charge plusieurs langues et offrir une exp√©rience utilisateur localis√©e. Ce guide fournit des instructions d√©taill√©es pour vous aider √† rendre votre application Next.js accessible √† un public mondial. Que vous d√©butiez avec Next.js ou cherchiez √† √©tendre les fonctionnalit√©s de votre application existante, ce document sera votre compagnon indispensable pour r√©ussir la mise en place de l'internationalisation.

## Installation des d√©pendances

Pour commencer, vous devez installer les d√©pendances n√©cessaires pour la gestion de l'internationalisation dans votre application Next.js. Pour cela, vous pouvez utiliser la commande suivante :

```bash copy
pnpm install @formatjs/intl-localematcher negotiator
```

- `@formatjs/intl-localematcher` : Cette biblioth√®que est utilis√©e pour d√©terminer la meilleure correspondance de locale (langue et r√©gion) √† utiliser dans une application web. Elle fournit des fonctionnalit√©s pour d√©tecter automatiquement la langue pr√©f√©r√©e de l'utilisateur en fonction des informations fournies par le navigateur ou d'autres sources, comme les en-t√™tes HTTP. En r√©sum√©, @formatjs/intl-localematcher facilite la s√©lection de la meilleure langue √† afficher dans une application en fonction des pr√©f√©rences linguistiques de l'utilisateur.
- `negotiator` : Negociator est une biblioth√®que qui permet de r√©aliser la n√©gociation de contenu HTTP. Dans le contexte de l'internationalisation, elle peut √™tre utilis√©e pour analyser les en-t√™tes HTTP accept-language envoy√©s par le navigateur de l'utilisateur. Ces en-t√™tes indiquent les langues pr√©f√©r√©es de l'utilisateur, ce qui est crucial pour fournir une exp√©rience localis√©e dans une application web. Negotiator peut aider √† extraire ces informations et √† les utiliser pour d√©terminer la meilleure langue √† utiliser dans le contenu de la page ou de l'application.

## Configuration de la structure des fichiers

> Pour ce guide, je pars du principe que vous utilisez le src folder de Next JS pour organiser votre code. Si ce n'est pas le cas, vous pouvez adapter les instructions en cons√©quence.

Pour commencer, vous devez organiser votre code de mani√®re √† faciliter la gestion de l'internationalisation dans votre application Next.js. Voici une structure de fichiers recommand√©e pour g√©rer les fichiers li√©s √† l'internationalisation :

```txt
src/
‚îî‚îÄ‚îÄ app/
    ‚îî‚îÄ‚îÄ [lang]/
        ‚îú‚îÄ‚îÄ components/
        ‚îÇ   ‚îî‚îÄ‚îÄ Button.tsx
        ‚îú‚îÄ‚îÄ globals.css
        ‚îú‚îÄ‚îÄ layout.tsx
        ‚îú‚îÄ‚îÄ page.tsx
        ‚îî‚îÄ‚îÄ providers.tsx
```

Avec cette m√©thode, nous devont int√©grer chaque √©l√©ments que nous voulons traduire dans le dossier `[lang]`. Par cons√©quent, le dossier `components` doit se trouv√© dans le dossier `app/[lang]` pour que les composants soient traduits.

## Configuration de l'internationalisation

Pour commencer, nous allons cr√©er un fichier `i18n.config.ts` √† la racine de notre projet et y ajouter le code suivant :

```ts filename="i18n.config.ts" showLineNumbers copy
export const i18n = {
  defaultLocale: "en",
  locales: ["fr", "en"],
} as const;
export type Locale = (typeof i18n)["locales"][number];
```

Ce fichier permet de d√©finir les param√®tres de configuration de l'internationalisation dans votre application Next.js. Vous pouvez sp√©cifier la langue par d√©faut (`defaultLocale`) et les langues prises en charge (`locales`). Dans cet exemple, nous avons d√©fini les langues `fr` (fran√ßais) et `en` (anglais) comme langues prises en charge. Vous pouvez ajouter d'autres langues selon les besoins de votre application.

Une fois ce fichier cr√©er, nous allons une props `lang` √† notre fichier `layout.tsx` ainsi qu'une fonction pour g√©n√©rer les param√®tres statique et ainsi fluidifier le chargement des textes. Pour cela :

```tsx filename="layout.tsx" copy showLineNumbers {5, 15-17, 21, 24, 27}
import "../globals.css";
import type { Metadata } from "next";
import { Inter } from "next/font/google";
import Providers from "./providers";
import { Locale, i18n } from "@/i18n.config";

const inter = Inter({ subsets: ["latin"] });

export const metaData: Metadata = {
  title: "Next.js i18n Guide",
  description:
    "Guide de mise en place de l'internationalisation (i18n) dans une application Next.js",
};

export async function generateStaticParams() {
  return i18n.locales.Map((locale) => ({ lang: locale }));
}

export default function RootLayout({
  children,
  params,
}: {
  children: React.ReactNode;
  params: { lang: Locale };
}) {
  return (
    <html lang={params.lang}>
      <body className={internal.classname}>
        <Providers>{children}</Providers>
      </body>
    </html>
  );
}
```

## Cr√©ons nos dictionaires de traduction

Dans cette √©tape, nous allons cr√©er des fichiers de dictionnaire de traduction pour chaque langue prise en charge dans votre application Next.js. Ces fichiers contiendront les traductions des textes utilis√©s dans votre application. Voici un exemple de structure de fichiers recommand√©e pour les dictionnaires de traduction :

```txt
src/
‚îî‚îÄ‚îÄ dictionaries/
    ‚îú‚îÄ‚îÄ fr.json
    ‚îî‚îÄ‚îÄ en.json
```

Dans ces fichiers, vous pouvez d√©finir les traductions pour chaque langue en utilisant une structure cl√©-valeur. Voici un exemple de contenu pour les fichiers `fr.json` et `en.json` :

```json filename="fr.json" copy showLineNumbers
{
  "pages": {
    "home": {
      "title": "G√©rer l'internationalisation dans Next.js",
      "content": "Apprenez √† configurer l'internationalisation dans votre application Next.js."
    },
    "about": {
      "title": "√Ä propos de nous",
      "content": "D√©couvrez notre √©quipe et notre mission."
    }
  },

  "components": {
    "button": {
      "home": "Accueil"
    }
  }
}
```

```json filename="en.json" copy showLineNumbers
{
  "pages": {
    "home": {
      "title": "Managing Internationalization in Next.js",
      "content": "Learn how to set up internationalization in your Next.js application."
    },
    "about": {
      "title": "About Us",
      "content": "Discover our team and our mission."
    }
  },

  "components": {
    "button": {
      "home": "Home"
    }
  }
}
```

Attention, il est important de respecter la structure des fichiers de traduction pour que les traductions soient correctement charg√©es dans votre application Next.js. Vous pouvez ajouter autant de cl√©s de traduction que n√©cessaire pour couvrir tous les textes de votre application. Le cl√©s doivent √™tre identiques. Seuls les valeurs doivent √™tre traduites.

## D√©clarons nos dictionnaires de traduction

Pour pouvoir utiliser les dictionnaires de traduction dans notre application Next.js, nous allons cr√©er le fichier `src/lib/dictionary.ts` et y ajouter le code suivant :

```ts filename="dictionary.ts" copy showLineNumbers
import "server-only";
import type { Locale } from "@/i18n.config";

const dictionaries = {
  fr: () => import("../dictionaries/fr.json").then((module) => module.default),
  en: () => import("../dictionaries/en.json").then((module) => module.default),
};

export const getDictionary = async (locale: Locale) => {
  return dictionaries[locale]();
};
```

Ce fichier permet de charger dynamiquement les dictionnaires de traduction en fonction de la langue s√©lectionn√©e dans votre application Next.js. Il utilise une m√©thode asynchrone pour charger le dictionnaire correspondant √† la langue sp√©cifi√©e. Vous pouvez ajouter d'autres langues et dictionnaires de traduction selon les besoins de votre application.

## Cas d'utilisation

Maintenant que nous avons configur√© les dictionnaires de traduction et les param√®tres de l'internationalisation dans notre application Next.js, nous allons voir comment utiliser ces √©l√©ments pour afficher des textes traduits dans notre application. Voici un exemple d'usage pour un composant :

```tsx filename="Button.tsx" copy showLineNumbers
import { Locale } from "@/i18n.config";
import { Link } from "next/link";

export interface ButtonProps {
  text: string;
  lang: Locale;
}

export default function Button({ text, lang }: ButtonProps) {
  return (
    <Link href={`/${lang}/accueil`}>
      <button>{text}</button>
    </Link>
  );
}
```

Dans ce composant `Button` nous cr√©ons un Bouton permettant de rediriger l'utilisateur vers la page d'accueil.
Pour cel√†, nous utilisons la props `lang` que nous d√©clarons dans le lien pour rediriger l'utilisateur vers la page d'accueil de la langue s√©lectionn√©e. Nous utilisons √©galement la props `text` pour afficher le texte du bouton en fonction de la lang s√©lectionn√©e par l'utilisateur.

Voyons comment nous pouvons utiliser ce composant dans une page par exemple :

```tsx filename="page.tsx" copy showLineNumbers {1-2, 5-6, 10-12}
import { Locale } from "@/i18n.config";
import { getDictionary } from "@/lib/dictionary";
import Button from "./components/Button";

export default async function Page({ params }: { params: { lang: Locale } }) {
  const { pages, components } = await getDictionary(params.lang);

  return (
    <div>
      <h1>{pages.about.title}</h1>
      <p>{pages.about.content}</p>
      <Button text={components.button.home} lang={lang} />
    </div>
  );
}
```
Dans cet exemple, nous utilisons la fonction `getDictionary` pour charger le dictionnaire de traduction correspondant √† la langue s√©lectionn√©e. Ensuite, nous utilisons les cl√©s de traduction pour afficher les textes traduits dans la page. Nous passons √©galement `{components.button.home}` dans la props `text` du composant `Button` pour afficher le texte du bouton en fonction de la langue s√©lectionn√©e. 

> Globalement, √† chaque fois que vous souhaitez afficher un texte traduit dans votre application Next.js, vous devez charger le dictionnaire de traduction correspondant √† la langue s√©lectionn√©e et utiliser les cl√©s de traduction pour afficher les textes traduits et document, ne plus √©crire de texte brute dans vos composants et vos pages. Cela vous permettra d'offrir une exp√©rience utilisateur localis√©e √† vos utilisateurs dans diff√©rentes langues.

## Donner √† l'utilisateur la possibilit√© de changer de langue

Pour offrir une exp√©rience utilisateur compl√®te, vous pouvez ajouter une fonctionnalit√© permettant √† l'utilisateur de changer la langue de l'application. Pour cela, vous pouvez ajouter un s√©lecteur de langue dans votre application Next.js. Voici un exemple de code pour un composant de s√©lecteur de langue :

```tsx filename="LanguageSelector.tsx" copy showLineNumbers
"use client";
import { i18n } from "@/i18n.config";
import { Button } from "@nextui-org/button";
import Link from "next/link";
import { usePathname } from "next/navigation";

export function ToggleLaguage() {
  const pathname = usePathname();
  const redirectedPathname = (locale: string) => {
    if (!pathname) return `/`;
    const segments = pathname.split("/");
    segments[1] = locale;
    return segments.join("/");
  };

  return (
    <div className=" flex flex-row gap-4 ">
      {i18n.locales.map(locale => {
        return (
          <Link key={locale} href={redirectedPathname(locale)}>
            <Button
              disableRipple
              className="bg-transparent p-0 hover:border-[#f67373] hover:text-[#f67373] data-[hover=true]:bg-transparent"
              radius="sm"
              size="sm"
              variant="bordered"
            >
              {locale.toUpperCase()}
            </Button>
          </Link>
        );
      })}
    </div>
  );
}
```
La fonction `ToggleLanguage` permet de cr√©er un s√©lecteur de langue qui affiche les langues prises en charge dans votre application Next.js. Lorsque l'utilisateur s√©lectionne une langue, il est redirig√© vers la page d'accueil de la langue s√©lectionn√©e. Vous pouvez personnaliser le style et le comportement du s√©lecteur de langue selon les besoins de votre application.

Pour utiliser ce composant dans votre application Next.js, vous pouvez l'ajouter √† votre `layout.tsx` ou √† un autre composant de mise en page. Par exemple :

```tsx filename="layout.tsx" copy showLineNumbers {6, 30}
import "../globals.css";
import type { Metadata } from "next";
import { Inter } from "next/font/google";
import Providers from "./providers";
import { Locale, i18n } from "@/i18n.config";
import { ToggleLanguage } from "./LanguageSelector";

const inter = Inter({ subsets: ["latin"] });

export const metaData: Metadata = {
  title: "Next.js i18n Guide",
  description:
    "Guide de mise en place de l'internationalisation (i18n) dans une application Next.js",
};

export async function generateStaticParams() {
  return i18n.localStorage.Map((locale) => ({ lang: locale }));
}

export default function RootLayout({
  children,
  params,
}: {
  children: React.ReactNode;
  params: { lang: Locale };
}) {
  return (
    <html lang={params.lang}>
      <body className={internal.classname}>
        <ToggleLanguage />
        <Providers>{children}</Providers>
      </body>
    </html>
  );
}
```

## Middleware 

> Pour la suite de ce guide, nous allons cr√©er un middleware que nous utiliserons dans une fonction `chain`. Cette fonction nous permettra d'utiliser plusieurs middleware dans notre application Next.js tout en gardant un code lisible et maintenable. Je vous montrerai donc comment coder un middleware pour l'internationalisation, mais si vous souhaitez savoir comment cr√©er cette fonction `chain`, je vous invite √† consulter la documentation qui en parle [ici](/docs/next/middleware).

Pour commencer nous allons cr√©er une fichier `src/middleware/withI18nMiddleware.ts` et y ajouter le code suivant :

```ts filename="withI18nMiddleware.ts" copy showLineNumbers
import type { NextFetchEvent, NextRequest } from "next/server";
import { NextResponse } from "next/server";

import { i18n } from "@/i18n.config";

import { match as matchLocale } from "@formatjs/intl-localematcher";
import Negotiator from "negotiator";
import { CustomMiddleware } from "./chain";

function getLocale(request: NextRequest): string | undefined {
  const negotiatorHeaders: Record<string, string> = {};
  request.headers.forEach((value, key) => (negotiatorHeaders[key] = value));

  // @ts-ignore locales are readonly
  const locales: string[] = i18n.locales;
  const languages = new Negotiator({ headers: negotiatorHeaders }).languages(locales);

  const locale = matchLocale(languages, locales, i18n.defaultLocale);
  return locale;
}

export function middleware(request: NextRequest) {}

export function withI18nMiddleware(middleware: CustomMiddleware) {
  return async (request: NextRequest, event: NextFetchEvent, response: NextResponse) => {
    const pathname = request.nextUrl.pathname;
    const pathnameIsMissingLocal = i18n.locales.every(
      locale => !pathname.startsWith(`/${locale}/`) && pathname !== `/${locale}`
    );

    // Redirect of there is no locale
    if (pathnameIsMissingLocal) {
      const locale = getLocale(request);
      return NextResponse.redirect(
        new URL(`/${locale}${pathname.startsWith("/") ? "" : "/"}${pathname}`, request.url)
      );
    }

    return middleware(request, event, response);
  };
}
```
Cette fonction `withI18nMiddleware` permet de cr√©er un middleware pour l'internationalisation dans votre application Next.js. Elle utilise la fonction `getLocale` pour d√©terminer la langue pr√©f√©r√©e de l'utilisateur en fonction des en-t√™tes HTTP accept-language envoy√©s par le navigateur. Si la langue n'est pas sp√©cifi√©e dans l'URL, le middleware redirige l'utilisateur vers la page correspondante dans la langue pr√©f√©r√©e. 

### Utilisation du middleware

Pour utiliser ce middleware vous devez le d√©clarer dans votre fonction `chain` pr√©sente dans le fichier `src/middleware.ts` de votre application Next. 
Voici un exemple de code pour d√©clarer le middleware d'internationalisation dans votre fonction `chain` :

```ts filename="middleware.ts" copy showLineNumbers {2, 4}
import { chain } from './middleware/chain'
import { withI18nMiddleware } from './middleware/withI18nMiddleware'

export default chain([withI18nMiddleware])

export const config = {
  // Matcher ignoring `/_next/` and `/api/`
  matcher: ["/((?!api|_next/static|_next/image|favicon.ico).*)"],
};
```
### Structure des fichiers

Voici la structure des fichier de votre application Next.js apr√®s avoir suivi ce guide :

```txt
root/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [lang]/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ Button.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ providers.tsx
‚îÇ   ‚îú‚îÄ‚îÄ dictionaries/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ fr.json
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ en.json
‚îÇ   ‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dictionary.ts
‚îÇ   ‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chain.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ withI18nMiddleware.ts
‚îÇ   ‚îî‚îÄ‚îÄ middleware.ts
‚îî‚îÄ‚îÄ i18n.config.ts
```

## Conclusion

> F√©licitations ! Vous avez r√©ussi √† mettre en place l'internationalisation dans votre application Next.js. Vous avez appris √† configurer les param√®tres de l'internationalisation, √† cr√©er des dictionnaires de traduction, √† charger les textes traduits dans votre application, √† permettre √† l'utilisateur de changer de langue et √† utiliser un middleware pour g√©rer l'internationalisation. Gr√¢ce √† ces √©tapes, vous pouvez offrir une exp√©rience utilisateur localis√©e √† vos utilisateurs dans diff√©rentes langues. Vous pouvez maintenant √©tendre ces fonctionnalit√©s et personnaliser l'internationalisation selon les besoins de votre application Next.js. Happy coding ! üöÄ